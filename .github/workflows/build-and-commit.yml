name: Build, Commit, and Update README

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # Needed to push commits back to the repo

jobs:
  build:
    runs-on: ${{ matrix.os }}
    continue-on-error: true  # Don't fail all jobs if one OS job fails
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            label: Linux
            ext: ""
          - os: windows-latest
            label: Windows
            ext: ".exe"
          - os: macos-latest
            label: macOS
            ext: ".app"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyqt5 pyautogui pyinstaller pystray pillow

      - name: Build portable app
        run: |
          pyinstaller --name "UtillBuddy${{ matrix.ext }}" --onefile --clean --noconfirm utill_buddy.py
          if [[ "${{ matrix.os }}" != "windows-latest" ]]; then
            strip dist/UtillBuddy${{ matrix.ext }} || echo "strip command not found, skipping"
          fi
        shell: bash

      - name: Prepare build directory and copy binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          mkdir -p portable/${{ matrix.label }}
          cp -f dist/UtillBuddy${{ matrix.ext }} portable/${{ matrix.label }}/
        shell: bash

      - name: Prepare build directory and copy binary (Windows)
        if: runner.os == 'Windows'
        run: |
          if (-Not (Test-Path -Path "portable/Windows")) { New-Item -ItemType Directory -Path "portable/Windows" }
          Copy-Item -Path dist/UtillBuddy.exe -Destination portable/Windows/ -Force
        shell: pwsh

      - name: Update README.md
        run: |
          NEW_LINK="ðŸ”¹ [Download for ${{ matrix.label }}](portable/${{ matrix.label }}/UtillBuddy${{ matrix.ext }})"
          START="<!-- BUILDS START -->"
          END="<!-- BUILDS END -->"
          awk -v s="$START" -v e="$END" -v l="$NEW_LINK" '
            $0 ~ s { print; print l; skip=1; next }
            $0 ~ e { skip=0; print; next }
            skip == 0 { print }
          ' README.md > README.tmp && mv README.tmp README.md
        shell: bash

      - name: Commit build and updated README
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git pull --rebase --autostash origin main
          git add portable/${{ matrix.label }}/ README.md
          git commit -m "Add ${{ matrix.label }} build and update README [auto]" || echo "Nothing to commit"
          git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
